#!/bin/bash

# Unofficial bash strict mode http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -eu
set -o pipefail
IFS=$'\n\t'

cat /app/sabnzbd/sabnzbd.ini \
  | sed "s|SABNZBD_API_KEY|$SABNZBD_API_KEY|" \
  | sed "s|EMAIL_FROM|$EMAIL_FROM|" \
  | sed "s|EMAIL_SERVER|$EMAIL_SERVER|" \
  | sed "s|EMAIL_TO|$EMAIL_TO|" \
  | sed "s|EMAIL_ACCOUNT|$MANDRILL_USERNAME|" \
  | sed "s|EMAIL_PASSWORD|$MANDRILL_PASSWORD|" \
  | sed "s|NEWSGROUPDIRECT_PASSWORD|$NEWSGROUPDIRECT_PASSWORD|" \
  | sed "s|NEWSGROUPDIRECT_USERNAME|$NEWSGROUPDIRECT_USERNAME|" \
  | sed "s|NZB_KEY|$NZB_KEY|" \
  | sed "s|OZNZB_API_KEY|$OZNZB_API_KEY|" \
  > /tmp/sabnzbd.ini

cat /app/sabnzbd/autoProcessMedia.cfg \
  | sed "s/SABNZBD_API_KEY/$SABNZBD_API_KEY/" \
  | sed "s/SICKRAGE_HOST/$SICKRAGE_HOST/" \
  | sed "s/SICKRAGE_PORT/$SICKRAGE_PORT/" \
  | sed "s/COUCHPOTATO_API_KEY/$COUCHPOTATO_API_KEY/" \
  | sed "s/COUCHPOTATO_HOST/$COUCHPOTATO_HOST/" \
  | sed "s/COUCHPOTATO_PORT/$COUCHPOTATO_PORT/" \
  | sed "s/PLEX_HOST/$PLEX_HOST/" \
  | sed "s/PLEX_PORT/$PLEX_PORT/" \
  > /opt/nzbToMedia/autoProcessMedia.cfg

# Clean environment variables not needed at runtime
# .env
unset EMAIL_SERVER
unset COUCHPOTATO_HOST
unset COUCHPOTATO_PORT
unset SICKRAGE_HOST
unset SICKRAGE_PORT
unset PLEX_HOST
unset PLEX_PORT
# .credentials
unset SABNZBD_API_KEY
unset MANDRILL_USERNAME
unset MANDRILL_PASSWORD
unset EMAIL_FROM
unset EMAIL_TO
unset NEWSGROUPDIRECT_USERNAME
unset NEWSGROUPDIRECT_PASSWORD
unset NZB_KEY
unset OZNZB_API_KEY
unset COUCHPOTATO_API_KEY

exec ${*:1}
